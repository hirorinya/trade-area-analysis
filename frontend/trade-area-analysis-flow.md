# 商圏分析ツール - データフロー図

## システム概要
商圏分析ツールは、人口データとメッシュ分析を基にした店舗最適配置システムです。

## データフロー

### 1. 入力データ
```
📊 基本データ
├── 🗾 地図境界データ (bounds)
│   ├── 北緯 (north)
│   ├── 南緯 (south)
│   ├── 東経 (east)
│   └── 西経 (west)
├── 🏪 店舗データ (stores)
│   ├── 店舗ID
│   ├── 店舗名
│   ├── 緯度・経度
│   ├── 店舗タイプ
│   └── 魅力度 (attractiveness)
├── 🏢 競合店データ (competitors)
│   ├── 競合店ID
│   ├── 店舗名
│   └── 緯度・経度
└── ⚙️ 分析パラメータ
    ├── メッシュサイズ (250m-1000m)
    ├── 商圏半径 (0.5km-5km)
    ├── 距離減衰係数 (1.5)
    └── 最大予算・店舗コスト
```

### 2. コア処理関数

#### A. 人口メッシュ生成
```javascript
📍 generateDemandGrid(bounds, meshSize)
入力: 地図境界, メッシュサイズ
処理: 
  ├── メーター→度数変換
  ├── グリッド座標計算
  ├── 人口密度シミュレーション
  │   ├── 東京中心部からの距離計算
  │   ├── 副次中心地（渋谷、新宿等）効果
  │   ├── 水域・居住不可地域除外
  │   └── 現実的な人口分布生成
  └── 需要計算 (人口 × 0.3)
出力: メッシュ配列 [
  {
    id: メッシュID,
    center: {lat, lng},
    bounds: {north, south, east, west},
    population: 人口数,
    demand: 需要量
  }
]
```

#### B. 需要捕捉計算（ハフモデル）
```javascript
🎯 calculateDemandCapture(meshes, stores, maxRadius, distanceDecay)
入力: メッシュ配列, 店舗配列, 最大商圏半径, 距離減衰係数
処理:
  ├── 各メッシュに対して
  │   ├── 商圏内店舗検索
  │   ├── 店舗魅力度計算 (attractiveness / distance^decay)
  │   ├── ハフモデル適用
  │   └── 捕捉率計算
  └── 競合考慮した需要配分
出力: 更新されたメッシュ配列 [
  {
    ...既存データ,
    capturedBy: [店舗ID配列],
    captureRatio: {店舗ID: 捕捉率}
  }
]
```

#### C. 店舗パフォーマンス分析
```javascript
📈 calculateStorePerformance(meshes, stores)
入力: 捕捉計算済メッシュ, 店舗配列
処理:
  ├── 各店舗の総需要捕捉量計算
  ├── 商圏メッシュ数カウント
  ├── 市場シェア計算
  └── 需要密度計算
出力: 店舗パフォーマンス指標 {
  店舗ID: {
    totalDemand: 総捕捉需要,
    meshCount: 商圏メッシュ数,
    marketShare: 市場シェア(%),
    demandDensity: 需要密度
  }
}
```

### 3. 最適化エンジン

#### A. 候補地生成
```javascript
🎯 generateCandidateSites(bounds, count, existingStores)
入力: 地図境界, 候補数, 既存店舗
処理:
  ├── ランダム座標生成
  ├── 既存店舗からの最小距離チェック (200m以上)
  └── 有効候補地フィルタリング
出力: 候補地配列 [
  {
    id: "candidate_X",
    lat: 緯度,
    lng: 経度,
    type: "candidate"
  }
]
```

#### B. 最適化アルゴリズム
```javascript
🔄 greedyOptimization(candidateSites, demandMeshes, params)
入力: 候補地, 需要メッシュ, パラメータ
処理:
  ├── 各候補地の需要捕捉ポテンシャル計算
  ├── 貪欲法による最適組み合わせ選択
  ├── カニバリゼーション効果考慮
  └── 予算制約チェック
出力: 最適化結果 {
  selectedSites: 選択された店舗候補,
  totalRevenue: 予想売上,
  totalCost: 総コスト,
  roi: 投資収益率,
  canalization: カニバリゼーション分析
}
```

### 4. 可視化出力

#### A. 地図表示
```
🗺️ LeafletMap コンポーネント
├── 📍 店舗マーカー (青色)
├── 🏢 競合店マーカー (赤色)
├── 📌 関心地点マーカー (緑色)
├── 🎨 人口密度メッシュ
│   ├── グラデーション表示 (薄青→濃紺)
│   ├── 需要量別色分け (0-20, 20-50, ..., 800+)
│   └── ポップアップ詳細情報
└── 📊 凡例
    ├── 店舗タイプ別アイコン
    ├── 人口密度スケール
    └── データソース表示
```

#### B. 分析結果
```
📈 分析レポート
├── 🏪 店舗別パフォーマンス
│   ├── 総捕捉需要
│   ├── 商圏範囲 (メッシュ数)
│   ├── 市場シェア (%)
│   └── 需要密度
├── 🎯 最適化結果
│   ├── 推奨店舗配置
│   ├── 予想売上・コスト
│   ├── ROI計算
│   └── リスク分析
└── 🔍 競合分析
    ├── カニバリゼーション影響
    ├── 市場カバレッジ
    └── 未開拓エリア特定
```

## データフロー全体図

```
📊 入力データ
     ↓
🔄 メッシュ生成 (generateDemandGrid)
     ↓
🎯 需要捕捉計算 (calculateDemandCapture)
     ↓
📈 パフォーマンス分析 (calculateStorePerformance)
     ↓
🎯 候補地生成 (generateCandidateSites)
     ↓
🔄 最適化計算 (greedyOptimization/mipOptimization)
     ↓
🗺️ 可視化出力 (LeafletMap + 分析レポート)
```

## 技術的特徴

### リアルタイム処理
- ✅ バッチ事前レンダリング（無限ループ回避）
- ✅ チャンク単位での段階的表示
- ✅ プログレスインジケーター付き

### 精度保証
- ✅ 東京都市圏に特化した人口分布モデル
- ✅ 水域・居住不可地域の自動除外
- ✅ ハフモデルによる競合考慮
- ✅ 複数座標フォーマット対応

### ユーザビリティ
- ✅ 調整可能パラメータ（メッシュサイズ、商圏半径）
- ✅ リアルタイムマップ更新
- ✅ 詳細ポップアップ情報
- ✅ 日本地理院タイル使用